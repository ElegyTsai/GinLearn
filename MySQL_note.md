# 高性能Mysql笔记
阅读《高性能MySQL》笔记

## MySQL架构
![](.MySQL_note_images/186fb856.png)
- 每个客户端连接都对应一个线程，线程的管理由主服务器完成
- 优化器用来解释查询，可以用explain来查看要素
- 事务的ACID特性/四个隔离级别
- InnoDB会检索死锁的循环依赖，返回一个错误。将持有最少行级排他锁的事务回滚
- MVCC是行级锁的变种，避免加锁操作。用快照来实现不加锁的读。

## MySQL基准测试和性能剖析
- 主要测试指标 latency/throughout/并发性
- 用慢查询日志来排查。SHOW PROFILES 可以显示查询记录的时间
- 剖析工具好复杂，看不懂

## 数据类型优化
- 原则：可以正确存储的最小数据类型/简单就好/避免null
- NULL的存在会让索引和存储更加复杂，最好使用NOT NULL
### 小数
- DECIMAL支持准确计算，不会出现FLOAT类型的取舍，而且可以用来存储比BIGINT还大的整数
- DECIMAL一般用在财务计算，还有一种神奇的方式是把小数放大用BIGINT来存
- MySQL默认用DOUBLE作为浮点计算的类型
### 字符串
- VARCHAR的空间可变，CHAR是固定。但是需要看MySQL的行是不是也是可变的。
- VARCHAR由长度和数据组成 。节省了空间，但是因为可以变长，update的时候会更麻烦。但是最好不要随便分配，也会造成性能损失。
- BLOB和TEXT用来专门处理长字符串，二进制存储。（效率比较差，尽可能不用）
- 枚举效率差，不用这个类型
### 时间和日期
- MySQL的时间粒度为秒
- DATETIME保存大范围的值，精度为秒。被封装成了YYYYMMDDHHMMSS的整数，时区无关，可排序
- TIMESTAMP是1970年以来的秒数。和时区有关。如果没有指定，就用系统时间来设置。
- 如果要存微秒以下的，可以自定义一个列，用double来存小数。
### 其他数据
- 提供了位数据存储
- IP地址可以转成整数再存储，MySQL提供了函数来操作

### SCHEMA设计要点
1. 列不要太多
2. 不要设置太多关联
3. 不要用太多枚举和SET
4. 避免NULL，可以用-1之类的。

### 使用范式
- 范式化的表格更新更快，操作更快
- 有第一第二第三第四范式等，参考[这个](https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%8C%83%E5%BC%8F/7309898)
- 反范式可以不用关联，可以避免随机IO
- 统计表和汇总表的使用更加高效
- 计数器表格的设计可以加入很多槽，再统一汇总来避免并行的锁
### 这章的总结
![](.MySQL_note_images/77874dd9.png)

## 高性能索引
- B-Tree索引和哈希索引，比较常见
- 空间数据索引 R-Tree 和全文索引
- 前缀长度保证前缀是唯一的
- 索引合并，联合索引
- 不用UUID，最好按顺序插入行，保证主键的递增
- order by要求和索引顺序和排序方向一致才能用索引
- 前缀压缩
- 冗余和重复索引会影响性能，冗余表示不需要的，MySQL可以创建重复索引
- 索引可以减少锁定的行，不走索引的话会发生全表扫描，并且用表锁。
- 在主键索引用排他锁，在二级索引用共享锁   
 

### trick
1. 可以用and in 来绕过某些前缀索引
2. 尽可能把需要范围查询的列放在后面
3. 避免多个范围条件（解决办法就是设置多个等值查询）
4. 对于大页数的排序，可以用延迟关联的方式避免扫描需要丢弃的行数
### 总结原则
![](.MySQL_note_images/80991ec2.png)

## 查询性能优化
### 主要要点
1. 是否向数据库请求了不需要的数据
2. 是否在扫描额外的记录
看一看扫描了多少行，以及访问类型。用EXPLAIN语句的type列来看访问类型。    
速度：全表扫描<索引扫描<范围扫描<唯一索引查询<常数引用

where在索引上可以用引擎优化，如果不在就是using where来主动剔除不满足需要的
- MySQL的设计让连接和断开都很轻量级，所以小查询有时候比复合查询更快速
- 分解关联查询
- MySQL是一个半双工的通信，无法中途断开接受，所以记得限制limit
- 关联是一个比较复杂的过程，通过潜逃循环的方式来实现
- 小范围排序在内存里进行，大范围的在磁盘里排序
- MySQL无法利用多核特性进行并行查询
- EXPLAIN可以提供一个近似值
- 关联查询的那一部分没有完全看懂
- group by 无法使用索引的时候，用临时表或者文件排序来做分组
- 延迟关联就是，只扫描覆盖索引，然后用覆盖索引去和原表做关联，减少要扫描的列
- 用书签的方法降低扫描开销
- 重复查询刚更新的数据可以用一个变量来记录
- 也可以用一个变量来统计修改的行数
- 区分冷热数据，用一个条件的偷懒查询来提高命中率
- 减少使用select for update
### 总结
![](.MySQL_note_images/893f5fa7.png)
